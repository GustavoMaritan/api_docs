<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Docs Payment</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/estrutura-site.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/controllers.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/json.css" type="text/css" rel="stylesheet" media="screen,projection" />

    <style>
        .request {
            display: none;
            flex-wrap: nowrap;
            justify-content: center;
            position: fixed;
            width: 100%;
            height: 100%;
            background-color: #000000bf;
            z-index: 100000;
        }

        .request-content {
            width: 90%;
            margin-top: 10px;
            max-width: 900px;
            height: 90%;
            background-color: white;
            border: 1px solid #ab47bc;
            -webkit-box-shadow: 0px 0px 15px -1px rgba(171, 71, 188, 1);
            -moz-box-shadow: 0px 0px 15px -1px rgba(171, 71, 188, 1);
            box-shadow: 0px 0px 15px -1px rgba(171, 71, 188, 1);
            overflow-y: auto;
        }

        .request-card {
            border: 1px solid #fbfbfb;
            border-left: 3px solid #b70000;
            font-size: 18px;
            padding: 7px !important;
            margin-bottom: 2px;
            color: #929292;
            font-weight: 500;
        }

        .txt-edit-json {
            width: 200px !important;
            padding-left: 5px !important;
            color: white !important;

        }

        @media only screen and (max-width: 850px) {
            .request-content {
                width: 100%;
                margin-top: 0px;
            }
        }

        @media only screen and (max-height: 775px) {
            .request-content {
                height: 90%;
                margin-top: 0px;
            }
        }
    </style>
</head>

<body>
    <nav class="top-menu">
        <div class="icon">
            <i class="material-icons">dehaze</i>
        </div>
        <div class="title">Docs Payment</div>
    </nav>
    <div class="conteudo">
        <div class="menu"></div>
        <div class="menu-aguarde"></div>
        <div class="corpo">
        </div>
        <div class="request">
            <div class="request-content">
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="js/materialize.js"></script>
    <script src="js/init.js"></script>
    <script src="js/site.js"></script>
    <script src="js/json.js"></script>
    <!--  TEMP PRA SIMULAR DADOS-->
    <script src="js/data.js"></script>
    <!--  FIM -->
    <script title="test-request">

        showRequest();
        function showRequest() {
            $('.request-content').html(gerarRequest(
                $json_documents.api,
                $json_documents.controllers[0].name,
                $json_documents.controllers[0].routes[0]
            ));
            $('.request').css({ display: 'flex' });
            $('select').formSelect();
        }

        function gerarRequest(api, controller, obj) {
            //$json_documents
            let headers = { ...api.headers, ...obj.headers };
            let divRow = $('<div>', { class: 'row' });
            let divCol12 = $('<div>', { class: 'col s12' });
            let divReqCard = $('<div>', { class: 'request-card' });
            let divInputS6 = $('<div>', { class: 'input-field col s6' })
            let form = $('<form>', { class: 'col s12' });
            form
                .append(divRow.clone())
                //ADICIONA CARDS INICIAIS (**bind valores url ao alterar os parametros)
                .append(
                    divRow.clone()
                        .append(divCol12.clone().append(divReqCard.clone().html(api.name)))
                        .append(divCol12.clone().append(divReqCard.clone().html(`${obj.method} - ${obj.name}`)))
                        .append(divCol12.clone().append(divReqCard.clone().html(`${api.url}/${api.prefix}/${obj.url}`)))
                );

            //HEADERS, PARAMS, BODY
            let rowsBody = divRow.clone();
            if (Object.keys(headers).length) {
                let _div = divCol12.clone();
                _div.append(divCol12.clone().html('<h5>Headers</h5>'))
                    .append(comp_params(headers, 'headers'))
                rowsBody.append(_div);
            }
            if (obj.params) {
                let _div = divCol12.clone();
                _div.append(divCol12.clone().html('<h5>Par√¢metros</h5>'))
                    .append(comp_params(obj.params, 'params'));
                rowsBody.append(_div);
            }

            obj.body = obj.bodyCase.itens[0].value;
            if (obj.body) {
                let _div = divCol12.clone();
                let jsonFormat = new $JsonFormat(obj.body, false, true);
                _div
                    .append(divCol12.clone().html('<h5>Body</h5>'))
                    .append(divCol12.clone().append($(`<div>`, {
                        class: "col s12 json",
                        html: jsonFormat.init()
                    }).attr('data-body', 'body')));
                rowsBody.append(_div);
            }
            form
                .append(divRow.clone().append(divCol12.clone().append(rowsBody)));

            let btnCancel = $('<a>', { class: 'btn', style: 'background-color: #cc0606; margin-left: 2px', text: 'Fechar' })
            let btnSubmit = $('<a>', { class: 'btn', style: 'background-color: #a236f4; margin-left: 2px', text: 'Testar Api' })


            btnCancel.click(() => {
                $('.request-content').empty();
                $('.request').slideUp();
            });

            btnSubmit.click(function () {
                let request = carregarForm(this);
                if (!form.find('[data-result]').length)
                    return send();

                form.find('[data-result]').slideUp(() => { send() });
                function send() {
                    $.ajax({
                        url: prepareUrl(api, obj.url, request.params),
                        method: obj.method.toUpperCase(),
                        headers: request.headers,
                        data: request.body
                    }).done((res) => {
                        form.find('[data-result]').remove();
                        let newResult = divRow.clone().css({ display: 'none' }).attr('data-result', '').append(
                            divCol12.clone().append('<div class="json">OIIIEEEEE</div>')
                        );
                        form.append(newResult);
                        newResult.slideDown();
                        form.closest('.request-content').animate({
                            scrollTop: form.find('[data-result]').position().top
                        }, 1000);
                    }).fail((err) => {
                        console.log('err', err);
                    })
                }
            });

            form.append(divRow.clone().css({ 'text-align': 'right' }).append(
                divCol12.clone().append(btnCancel).append(btnSubmit)
            ));
            return divRow.clone().append(form);
        }

        function carregarForm(btn) {
            let form = $(btn).closest('form');
            let body = form.find('[data-bodywww]').text().trim();

            let request = {
                body: body ? JSON.parse(body) : undefined,
                headers: {},
                params: {}
            }
            form.find('[data-headers]').each(function () {
                request.headers[$(this).attr('data-headers')] = $(this).val();
            });
            form.find('[data-params]').each(function () {
                request.params[$(this).attr('data-params')] = $(this).val();
            });
            return request;
        }

        function comp_params(obj, name) {
            let body = [];
            for (let i in obj) {
                let input = {
                    attr: name,
                    name: i,
                    required: '',
                    value: '',
                    type: 'string'
                }
                if (typeof obj[i] == 'object') {
                    input.value = obj[i].testValue || obj[i].default || '';
                    input.required = obj[i].required ? 'required' : '';
                    input.type = obj[i].type
                        ? typeof obj[i].type == 'function'
                            ? obj[i].type.name
                            : obj[i].type
                        : '';
                }
                body.push(`
                    <div class="col s12">
                        <div class="input-field col s6">
                            <input value="${(input.required ? '* ' : '') + i}" type="text" readonly>
                        </div>
                        <div class="input-field col s6">
                            ${comp_input_select(obj[i].opcoes, input)}
                        </div>
                    </div>          
                `)
            }
            return body.join('');
        }

        function comp_input_select(opcoes, input) {
            if (!opcoes || !opcoes.length)
                return `<input 
                    id="text" 
                    data-${input.attr}="${input.name}"
                    placeholder="${input.type}" 
                    type="text" 
                    value="${input.value}" ${input.required}>
                `;
            let opcs = opcoes
                .map(x => `<option value="${x}" ${input.value == x ? 'selected' : ''}>${x}</option>`);
            return `<select data-${input.attr}="${input.name}" ${input.required}>
                        ${opcs.join('')}
                    </select>`;
        }

        function formatUrl(url, prefix, route) {
            url = url.substr(url.length - 1) == '/'
                ? url.substr(0, url.length - 1)
                : url;
            route = route.split('?')[0];
            route = route.split('/').join('/');

            url = prefix ? `${url}/${prefix}` : url;
            url = `${url}/${route}`;
            return url;
        }

        function prepareUrl(api, route, params) {
            let url = formatUrl(api.url, api.prefix, route);
            params = params || {};
            let queryString = [];
            for (let i in params) {
                if (url.includes(':' + i))
                    url = url.replace(':' + i, 'brasil');//params[i]
                else
                    queryString.push(i + '=' + 'download');//params[i]
            }
            return url + (queryString.length ? '?' + queryString.join('&') : '');
        }
    </script>
</body>
</html>
